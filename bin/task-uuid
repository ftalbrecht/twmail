#!/usr/bin/env ruby
# frozen_string_literal: true

require 'securerandom'
require 'optparse'
require 'twmail'

OptionParser.new do |opts|
  banner = <<~HERE
    #{opts.program_name} creates a new TaskWarrior task and prints its UUID to STDOUT using the following approach:

      1. Make up a temporary tag name that is very unlikely to exist yet.

      2. Create the new task tagged with our temporary tag

      3. Use the name of our temporary tag to find the actual UUID generated by TaskWarrior

      4. Remove the temporary tag from the new task

      5. Print the UUID to STDOUT
HERE
  opts.banner = banner
  opts.version = TaskWarriorMail::VERSION
end.parse!

# 1. Make a temporary tag that unlikely to exist yet.
# To avoid shell troubles, we have it start with a character.
tag = 'tag_' + SecureRandom.hex.tr('-', '')

# 2. Create the new task tagged with our temporary tag
`task rc.verbose=nothing add +#{tag} #{ARGV.join(' ')}`

# 3. Remember the UUID generated by TaskWarrior
task_uuid = `task rc.verbose=nothing +#{tag} _uuid`.chomp

# 4. Remove the temporary tag from the new task
`task rc.verbose=nothing #{task_uuid} modify -#{tag.to_s}`

# 5. Print the UUID to STDOUT
puts task_uuid
